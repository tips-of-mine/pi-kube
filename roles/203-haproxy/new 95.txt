yum install gcc pcre-static pcre-devel -y

wget http://www.haproxy.org/download/2.1/src/haproxy-2.1.2.tar.gz -O ~/haproxy.tar.gz

tar xzvf ~/haproxy.tar.gz -C ~/

cd ~/haproxy-2.1.2

make TARGET=kubernetes

make install

mkdir -p /etc/haproxy && mkdir -p /var/lib/haproxy 

touch /var/lib/haproxy/stats

ln -s /usr/local/sbin/haproxy /usr/sbin/haproxy

cp ./examples/haproxy.init /etc/init.d/haproxy

chmod 755 /etc/init.d/haproxy

systemctl daemon-reload

systemctl enable haproxy

useradd -r haproxy

nano /etc/haproxy/haproxy.cfg
______________________________________________________________________________________________________________Debut de modification du fichier
global
   log                      /dev/log local0
   log                      /dev/log local1 notice
   chroot                   /var/lib/haproxy
   pidfile                  /var/run/haproxy.pid
   stats socket             /var/lib/haproxy/stats
   maxconn                  5000
   stats timeout            30s
   user haproxy
   group haproxy
   daemon

defaults
    mode                    http
    log                     global
    option                  redispatch
    retries                 3
    timeout http-request    10s
    timeout queue           1m
    timeout connect         10s
    timeout client          1m
    timeout server          1m
    timeout http-keep-alive 10s
    timeout check           10s
    maxconn                 5000

frontend http_stats
   bind *:8081
   mode http
   stats uri /haproxy?stats

frontend haproxy_kube
    bind *:6444
    mode tcp
    timeout client  10800s
    default_backend kmasters

backend kmasters
    mode tcp
    balance leastconn
    timeout server  10800s
    default-server inter 3s fall 3 rise 2
    server master1 10.101.31.10:6443 check port 6443
    server master2 10.101.32.10:6443 check port 6443
    server master3 10.101.31.11:6443 check port 6443
    server master4 10.101.32.11:6443 check port 6443

backend kworker
    mode tcp
    balance leastconn
    timeout server  10800s
	default-server inter 3s fall 3 rise 2
    server kworker1 10.101.24.30
    server kworker2 10.101.25.30
    server kworker3 10.101.24.31
    server kworker4 10.101.25.31
______________________________________________________________________________________________________________

systemctl start haproxy

yum install -y keepalived

nano /etc/keepalived/
______________________________________________________________________________________________________________Debut de modification du fichier
vrrp_script chk_haproxy {
        script "killall -0 haproxy"
        interval 2
        weight 2
}

vrrp_instance VI_1 {
        interface ens192
        state MASTER
        virtual_router_id 51
        priority 101            # 100 on kmaster-01, 101 on kmaster-02, 103 on kmaster-03, 104 on kmaster-04
        virtual_ipaddress {
            10.101.29.1        	# the virtual IP
        }
        track_script {
            chk_haproxy
        }
}
______________________________________________________________________________________________________________

systemctl enable keepalived & systemctl start keepalived
